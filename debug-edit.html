<!DOCTYPE html>
<html>
<head>
    <title>Debug Form Submit</title>
    <style>
        body { font-family: Arial; margin: 30px; }
        #log { background: #f0f0f0; padding: 15px; border-radius: 4px; height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px; }
        button { padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 10px 0; }
        button:hover { background: #45a049; }
    </style>
</head>
<body>
    <h1>Debug: Form Submit Test</h1>
    <button onclick="testSubmit()">Test Simple Submit (ID 1)</button>
    <button onclick="testEdit()">Test Edit (ID 1)</button>
    <button onclick="clearLog()">Clear Log</button>
    <div id="log"></div>

    <script>
        function addLog(msg, type = 'info') {
            const log = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            const line = `<div style="color: ${color};">[${time}] ${msg}</div>`;
            log.innerHTML += line;
            log.scrollTop = log.scrollHeight;
            console.log(msg);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        async function testSubmit() {
            addLog('Starting testSubmit...', 'info');
            
            try {
                const formData = new FormData();
                formData.append('action', 'update_patient');
                formData.append('patient_id', '1');
                formData.append('nama_pasien', 'Test Name ' + Date.now());
                formData.append('tanggal_lahir', '2025-11-06');
                formData.append('alamat', 'Test Address ' + Date.now());
                formData.append('jenis_layanan', 'rawat-jalan');
                formData.append('status_pasien', 'selesai');
                formData.append('hasil_pemeriksaan', 'Test Result ' + Date.now());
                formData.append('jumlah_pembayaran', '999');

                addLog('Sending fetch to ./backend/dashboardview.php', 'info');
                
                const response = await fetch('./backend/dashboardview.php', {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin'
                });

                addLog(`Response status: ${response.status}`, 'info');
                
                const text = await response.text();
                addLog(`Response text length: ${text.length}`, 'info');
                
                try {
                    const data = JSON.parse(text);
                    if (data.success) {
                        addLog(`✓ Success: ${data.message}`, 'success');
                    } else {
                        addLog(`✗ Error: ${data.error}`, 'error');
                    }
                } catch (parseErr) {
                    addLog(`✗ JSON parse error: ${parseErr.message}`, 'error');
                    addLog(`First 200 chars: ${text.substring(0, 200)}`, 'error');
                }
            } catch (error) {
                addLog(`✗ Fetch error: ${error.message}`, 'error');
            }
        }

        async function testEdit() {
            addLog('Starting testEdit flow...', 'info');
            
            // Step 1: Get patient
            try {
                addLog('Step 1: Fetching patient data...', 'info');
                let response = await fetch('./backend/dashboardview.php?action=get_patient_detail&patient_id=1', 
                    { credentials: 'same-origin' });
                let data = await response.json();
                
                if (!data.success) {
                    addLog(`✗ Get patient failed: ${data.error}`, 'error');
                    return;
                }
                
                addLog(`✓ Got patient: ${data.data.nama_lengkap}`, 'success');
                
                // Step 2: Edit and submit
                addLog('Step 2: Submitting edit...', 'info');
                
                const formData = new FormData();
                formData.append('action', 'update_patient');
                formData.append('patient_id', '1');
                formData.append('nama_pasien', 'Edited ' + Date.now());
                formData.append('tanggal_lahir', data.data.tanggal_lahir);
                formData.append('alamat', data.data.alamat_lengkap + ' EDITED');
                formData.append('jenis_layanan', data.data.informasi_medis);
                formData.append('status_pasien', data.data.status_pasien);
                formData.append('hasil_pemeriksaan', data.data.hasil_pemeriksaan + ' EDITED');
                formData.append('jumlah_pembayaran', data.data.jumlah_pembayaran);

                response = await fetch('./backend/dashboardview.php', {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin'
                });

                data = await response.json();
                if (data.success) {
                    addLog(`✓ Edit successful: ${data.message}`, 'success');
                } else {
                    addLog(`✗ Edit failed: ${data.error}`, 'error');
                }
            } catch (error) {
                addLog(`✗ Error: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
