<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Test Lihat & Edit Pasien</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
        }
        .section {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
            border-left: 3px solid #4CAF50;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        pre {
            background: white;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            border: 1px solid #ddd;
        }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        input, select {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 5px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: #000;
        }
    </style>
</head>
<body>
    <h1>ðŸ§ª Test Lihat & Edit Data Pasien</h1>
    
    <div class="section">
        <h2>Step 1: Lihat Detail Pasien</h2>
        <label>ID Pasien: <input id="patientId" type="number" value="1"></label>
        <button onclick="viewPatient()">Lihat Detail Pasien</button>
        <pre id="viewOutput"></pre>
    </div>

    <div class="section">
        <h2>Step 2: Edit Pasien</h2>
        <button onclick="editPatient()">Edit Pasien (ID 1)</button>
        <pre id="editOutput"></pre>
    </div>

    <!-- Modal untuk menampilkan detail -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Detail Pasien</h2>
            <div id="patientDetails"></div>
        </div>
    </div>

    <script>
        function log(elementId, msg, type = 'info') {
            const el = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'success' ? 'âœ“' : type === 'error' ? 'âœ—' : 'â„¹';
            const className = type;
            el.innerHTML += `<span class="${className}">[${timestamp}] ${prefix}</span> ${msg}\n`;
        }

        async function viewPatient() {
            const patientId = document.getElementById('patientId').value;
            document.getElementById('viewOutput').innerHTML = '';
            
            log('viewOutput', `Mengambil data pasien ID: ${patientId}...`, 'info');
            
            try {
                const url = `./backend/dashboardview.php?action=get_patient_detail&patient_id=${patientId}`;
                log('viewOutput', `Fetching: ${url}`, 'info');
                
                const response = await fetch(url, {
                    credentials: 'same-origin'
                });
                
                log('viewOutput', `Response status: ${response.status}`, 'info');
                
                const data = await response.json();
                
                if (data.success) {
                    log('viewOutput', `âœ“ Data berhasil dimuat!`, 'success');
                    log('viewOutput', `Nama: ${data.data.nama_lengkap}`, 'success');
                    log('viewOutput', `Alamat: ${data.data.alamat_lengkap}`, 'success');
                    
                    // Display di modal
                    displayPatientModal(data.data);
                    document.getElementById('detailModal').style.display = 'block';
                } else {
                    log('viewOutput', `âœ— Error: ${data.error}`, 'error');
                }
            } catch (error) {
                log('viewOutput', `âœ— Exception: ${error.message}`, 'error');
                console.error(error);
            }
        }

        function displayPatientModal(patient) {
            const details = document.getElementById('patientDetails');
            details.innerHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <tr><td style="border: 1px solid #ddd; padding: 8px;"><strong>ID</strong></td><td style="border: 1px solid #ddd; padding: 8px;">${patient.id_pasien}</td></tr>
                    <tr><td style="border: 1px solid #ddd; padding: 8px;"><strong>Nama</strong></td><td style="border: 1px solid #ddd; padding: 8px;">${patient.nama_lengkap}</td></tr>
                    <tr><td style="border: 1px solid #ddd; padding: 8px;"><strong>Tgl Lahir</strong></td><td style="border: 1px solid #ddd; padding: 8px;">${patient.tanggal_lahir}</td></tr>
                    <tr><td style="border: 1px solid #ddd; padding: 8px;"><strong>Alamat</strong></td><td style="border: 1px solid #ddd; padding: 8px;">${patient.alamat_lengkap}</td></tr>
                    <tr><td style="border: 1px solid #ddd; padding: 8px;"><strong>Status</strong></td><td style="border: 1px solid #ddd; padding: 8px;">${patient.status_pasien}</td></tr>
                    <tr><td style="border: 1px solid #ddd; padding: 8px;"><strong>Layanan</strong></td><td style="border: 1px solid #ddd; padding: 8px;">${patient.informasi_medis}</td></tr>
                    <tr><td style="border: 1px solid #ddd; padding: 8px;"><strong>Hasil Pemeriksaan</strong></td><td style="border: 1px solid #ddd; padding: 8px;">${patient.hasil_pemeriksaan}</td></tr>
                    <tr><td style="border: 1px solid #ddd; padding: 8px;"><strong>Pembayaran</strong></td><td style="border: 1px solid #ddd; padding: 8px;">Rp ${parseFloat(patient.jumlah_pembayaran).toLocaleString('id-ID')}</td></tr>
                </table>
            `;
        }

        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        async function editPatient() {
            document.getElementById('editOutput').innerHTML = '';
            const patientId = 1;
            
            log('editOutput', `Mengambil data pasien untuk edit (ID: ${patientId})...`, 'info');
            
            try {
                const url = `./backend/dashboardview.php?action=get_patient_detail&patient_id=${patientId}`;
                const response = await fetch(url, {
                    credentials: 'same-origin'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log('editOutput', `âœ“ Data dimuat untuk edit`, 'success');
                    log('editOutput', `Nama: ${data.data.nama_lengkap}`, 'success');
                    
                    // Show form
                    const form = `
                        <form onsubmit="submitEdit(event, ${patientId})">
                            <div>
                                <label>Nama:</label><br>
                                <input type="text" name="nama_pasien" value="${data.data.nama_lengkap}" required style="width: 100%;">
                            </div>
                            <div>
                                <label>Tgl Lahir:</label><br>
                                <input type="date" name="tanggal_lahir" value="${data.data.tanggal_lahir}" required>
                            </div>
                            <div>
                                <label>Alamat:</label><br>
                                <input type="text" name="alamat" value="${data.data.alamat_lengkap}" required style="width: 100%;">
                            </div>
                            <div>
                                <label>Layanan:</label><br>
                                <select name="jenis_layanan" required>
                                    <option value="rawat-inap" ${data.data.informasi_medis === 'rawat-inap' ? 'selected' : ''}>Rawat Inap</option>
                                    <option value="rawat-jalan" ${data.data.informasi_medis === 'rawat-jalan' ? 'selected' : ''}>Rawat Jalan</option>
                                    <option value="pemeriksaan" ${data.data.informasi_medis === 'pemeriksaan' ? 'selected' : ''}>Pemeriksaan</option>
                                </select>
                            </div>
                            <div>
                                <label>Status:</label><br>
                                <select name="status_pasien" required>
                                    <option value="menunggu" ${data.data.status_pasien === 'menunggu' ? 'selected' : ''}>Menunggu</option>
                                    <option value="proses" ${data.data.status_pasien === 'proses' ? 'selected' : ''}>Proses</option>
                                    <option value="selesai" ${data.data.status_pasien === 'selesai' ? 'selected' : ''}>Selesai</option>
                                </select>
                            </div>
                            <div>
                                <label>Hasil Pemeriksaan:</label><br>
                                <textarea name="hasil_pemeriksaan" required style="width: 100%; height: 100px;">${data.data.hasil_pemeriksaan}</textarea>
                            </div>
                            <div>
                                <label>Jumlah Pembayaran:</label><br>
                                <input type="number" name="jumlah_pembayaran" value="${data.data.jumlah_pembayaran}" step="0.01" required>
                            </div>
                            <button type="submit">Simpan Perubahan</button>
                            <button type="button" onclick="document.getElementById('editOutput').innerHTML += '\\n[Dibatalkan]'">Batal</button>
                        </form>
                    `;
                    document.getElementById('editOutput').innerHTML = form;
                } else {
                    log('editOutput', `âœ— Error: ${data.error}`, 'error');
                }
            } catch (error) {
                log('editOutput', `âœ— Exception: ${error.message}`, 'error');
            }
        }

        async function submitEdit(event, patientId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            formData.append('patient_id', patientId);
            
            log('editOutput', '\nâœ“ Mengirim update...', 'info');
            
            try {
                const response = await fetch('./backend/dashboardview.php?action=update_patient', {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    log('editOutput', `âœ“ Data berhasil diupdate!`, 'success');
                } else {
                    log('editOutput', `âœ— Update error: ${data.error}`, 'error');
                }
            } catch (error) {
                log('editOutput', `âœ— Exception: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
